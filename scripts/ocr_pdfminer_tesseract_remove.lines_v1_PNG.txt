#this script does the same as 'pdfminer_tesseract_remove.lines_v1' but with .PNG files.
-
-
-
-
-
import cv2
import numpy as np
import pytesseract
import os
import matplotlib.pyplot as plt

def remove_lines(gray_image):
  thresh = cv2.threshold(gray_image, 0, 255, cv2.THRESH_BINARY_INV + cv2.THRESH_OTSU)[1]

  horizontal_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (40, 1))
  remove_horizontal = cv2.morphologyEx(thresh, cv2.MORPH_OPEN, horizontal_kernel, iterations=2)
  cnts = cv2.findContours(remove_horizontal, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
  cnts = cnts[0] if len(cnts) == 2 else cnts[1]
  for c in cnts:
      cv2.drawContours(thresh, [c], -1, (0, 0, 0), 5)

  vertical_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (1, 40))
  remove_vertical = cv2.morphologyEx(thresh, cv2.MORPH_OPEN, vertical_kernel, iterations=2)
  cnts = cv2.findContours(remove_vertical, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
  cnts = cnts[0] if len(cnts) == 2 else cnts[1]
  for c in cnts:
      cv2.drawContours(thresh, [c], -1, (0, 0, 0), 5)

  kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (3, 3))
  result = 255 - cv2.dilate(thresh, kernel, iterations=1)

  return result

def process_png_image(png_path):
  if not os.path.exists(png_path):
      print(f"Error: The file {png_path} does not exist.")
      return None

  try:
      # Read the PNG image
      image = cv2.imread(png_path)

      # Convert to grayscale
      gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)

      # Remove lines
      no_lines = remove_lines(gray)

      # Create the output directory if it doesn't exist
      home_dir = os.path.expanduser("~")
      output_directory = os.path.join(home_dir, 'Documents', 'prep_res')
      os.makedirs(output_directory, exist_ok=True)

      # Generate output filename
      base_name = os.path.basename(png_path)
      name, _ = os.path.splitext(base_name)
      output_path = os.path.join(output_directory, f"{name}_processed.png")

      # Save the processed image
      cv2.imwrite(output_path, no_lines)
      print(f"Processed image saved to: {output_path}")

      # Perform OCR on the image with lines removed
      text = pytesseract.image_to_string(no_lines, lang='hun', config='--psm 6')

      # Display images
      fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(15, 15))

      ax1.imshow(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))
      ax1.set_title('Original Image')
      ax1.axis('off')

      ax2.imshow(gray, cmap='gray')
      ax2.set_title('Grayscale Image')
      ax2.axis('off')

      ax3.imshow(cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY_INV + cv2.THRESH_OTSU)[1], cmap='gray')
      ax3.set_title('Threshold')
      ax3.axis('off')

      ax4.imshow(no_lines, cmap='gray')
      ax4.set_title('Image with Lines Removed')
      ax4.axis('off')

      plt.tight_layout()
      plt.show()

      return text

  except Exception as e:
      print(f"An error occurred while processing {png_path}: {str(e)}")
      return None

# Main execution
home_dir = os.path.expanduser("~")
image_directory = os.path.join(home_dir, 'Documents', 'mock_inv_bill_png')
output_directory = os.path.join(home_dir, 'Documents', 'ocr_png_combined')
os.makedirs(output_directory, exist_ok=True)

for filename in os.listdir(image_directory):
  if filename.lower().endswith('.png'):
      png_path = os.path.join(image_directory, filename)

      print(f"Processing {filename}...")
      extracted_text = process_png_image(png_path)

      if extracted_text:
          output_filename = f"{os.path.splitext(filename)[0]}_extracted.txt"
          output_path = os.path.join(output_directory, output_filename)

          try:
              with open(output_path, 'w', encoding='utf-8') as f:
                  f.write(extracted_text)
              print(f"Extracted text saved to {output_filename}")
          except Exception as e:
              print(f"Error saving extracted text for {filename}: {str(e)}")
      else:
          print(f"Failed to extract text from {filename}")

print("\nProcessing completed.")
print("Created/Modified files during execution:")
print(*[f for f in os.listdir(output_directory) if f.endswith('_extracted.txt')], sep='\n')
print(*[f for f in os.listdir(os.path.join(home_dir, 'Documents', 'prep_res')) if f.endswith('_processed.png')], sep='\n')